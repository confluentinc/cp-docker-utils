version: v1.0
name: cp-docker-utils
agent:
  machine:
    type: s1-prod-ubuntu24-04-amd64-1
execution_time_limit:
  hours: 1
global_job_config:
  prologue:
    commands:
      - checkout
      - . vault-setup
      - sem-version go $(cat .go-version)
blocks:
  - name: Go Test
    dependencies: []
    task:
      jobs:
        - name: Go Test
          commands:
            - make go-test
  - name: Go Format check
    dependencies: []
    task:
      jobs:
        - name: Go Format check
          commands:
            - make go-check-fmt
  - name: Create new version commit and tag
    dependencies:
      - Go Test
      - Go Format check
    run:
      when: "branch = 'master'"
    task:
      jobs:
        - name: Create new version commit and tag
          commands:
            - git checkout $SEMAPHORE_GIT_BRANCH
            - git reset --hard
            - bumpversion patch # Refers .bumpversion.cfg for configuration
            - LATEST_TAG=$(git describe --tags --abbrev=0)
            - git push origin $SEMAPHORE_GIT_BRANCH
            - git push origin $LATEST_TAG